<!DOCTYPE html> 
<html lang="en">
<head>
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/grids-responsive-min.css">
<style>
body, pre {
	font-size: 13px;
	line-height: 17px;
	font-family: monospace, Segoe UI Symbol;
	white-space: pre-wrap;
}
#historydata{
	max-height:700px;
    overflow:auto;
}
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <meta charset="utf-8" />
    <title>brdg.me web client</title>
</head>
<body>
<div class="pure-g">
	<div class="pure-u-1 pure-u-md-12-24"><div id="gamedata"></div><div id="command"><form onsubmit="sendCommand();return false;"> Command: <input type="text" name="comm" id="comm" autofocus><br><input type="Submit"></form></div></div>

	<div class="pure-u-1 pure-u-md-8-24" id="historydata"></div>

	<div class="pure-u-1 pure-u-md-4-24" id="gamelist"></div>

    <script>
    var token = localStorage.getItem("token");
    $(window).load(function() {
        //var token = localStorage.getItem("token");
        if (token == null){
			window.location.replace("http://baconheist.com/brdgme");
        }

    });

		var QueryString = function () {
			var query_string = {};
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
				if (typeof query_string[pair[0]] === "undefined") {
					query_string[pair[0]] = pair[1];
				} else if (typeof query_string[pair[0]] === "string") {
					var arr = [ query_string[pair[0]], pair[1] ];
					query_string[pair[0]] = arr;
				} else {
					query_string[pair[0]].push(pair[1]);
				}
			} 
		return query_string;
		} ();
		//alert (QueryString.id);				  
		//var strAuth = "token "+QueryString.mail;
		$.ajax('http://brdg.me/game/'+QueryString.id, {
				headers: {
					Authorization: 'token '+token
				},
				success: function(data) {
					//alert("Request worked, open your JS console to see the data.");
					console.log(data);
					//alert(data.games[0].identifier);
					//document.getElementById("gamedata").innerHTML=text;
					var text="<pre>" + data.game + "</pre><br /><pre>" + data.commands + "</pre><br />";
					document.getElementById("gamedata").innerHTML = text;
					var history="<pre>" + data.log + "</pre><br />";
					document.getElementById("historydata").innerHTML = history;	
					var objDiv = document.getElementById("historydata");
					objDiv.scrollTop = objDiv.scrollHeight;	
					$('#comm').focus();	

				}
			});
			getGames(token);

	var server = "brdg.me";
	var user = QueryString.mail;
	var exampleSocket = new WebSocket("ws://"+server+"/ws");
	exampleSocket.onopen = function(event) {
    // Authenticate
    console.log('Connected, authenticating');
    console.log(token);
    
    exampleSocket.send(JSON.stringify(token));
	};
	exampleSocket.onmessage = function(event) {
    // We were sent a game update
    console.log("WebSocket event");
    console.log(JSON.parse(event.data));
    obj = JSON.parse(event.data);
    if(obj.gameId==QueryString.id)
    {
		//location.reload();
		//document.getElementById("gamedata").innerHTML += "YOUR TURN! (please refresh) ";
		console.log("WebSocket event - this game");
    	console.log(JSON.parse(event.data));
    	$.ajax('http://brdg.me/game/'+QueryString.id, {
				headers: {
					Authorization: 'token '+token
				},
				success: function(data) {
					console.log("ajax success after websocket event");
					//alert("Request worked, open your JS console to see the data.");
					console.log(data);
					//alert(data.games[0].identifier);
					//document.getElementById("gamedata").innerHTML=text;
					var text="<pre>" + data.game + "</pre><br /><pre>" + data.commands + "</pre><br />";
					document.getElementById("gamedata").innerHTML = text;
					var history="<pre>" + data.log + "</pre><br />";
					document.getElementById("historydata").innerHTML = history;	
					var objDiv = document.getElementById("historydata");
					objDiv.scrollTop = objDiv.scrollHeight;		
					$('#comm').focus();	

				}
			});
	};
	getGames(token);
};
	exampleSocket.onclose = function(event) {
    // Connection crapped out
    alert('The connection died, click OK to refresh');
    //location.reload();
};

function sendCommand(){
	//$("button").click(function(){
	var comm = $("#comm").val();


//alert(comm);
//alert(strAuth);
	$.ajax('http://brdg.me/game/'+QueryString.id+'/command', {
	headers: {
    	Authorization: 'token '+token
  	},
  	method: 'POST',
	data: {'command': comm},
	success: function(data) { 
			console.log("posted");
			console.log(data);
			var text="<pre>" + data.game + "</pre><br /><pre>" + data.commands + "</pre>";
			document.getElementById("gamedata").innerHTML = text;
			var history="<pre>" + data.log + "</pre><br />";
			document.getElementById("historydata").innerHTML = history;
			$('#comm').val("");
		    //alert('Successfully posted. Click OK to refresh');
            //location.reload();  
       } 
  	    });
	};
    function getGames(token){

         $.ajax('http://brdg.me/game', {

        headers: {
    	Authorization: 'token '+token
        },

        success: function (data) {

        //alert("Request worked, open your JS console to see the data.");

            console.log(data);

        //alert(data.games[0].identifier);

            var text = "";

            for (i = 0; i < data.length; i = i + 1) {
                          
                text += "<a href=\"game.html?id=" + data[i].id +"\">" + data[i].identifier + "</a> with ";

                for (n = 0; n < data[i].playerList.length; n = n + 1){
                    if (n==(data[i].playerList.length-1)){
                        text+= data[i].playerList[n];
                    }
                    else
                    {
                       text+= data[i].playerList[n]+" and "; 
                    }
                    

                }

                text += "<br />";

            } 
            document.getElementById("gamelist").innerHTML = text; 
        } 
    });

    }

    var titleInterval;
var originalTitle;
var blinked;
function setTitle(toggle) {
    if (toggle === undefined) {
        // Check if we have any active games, set toggle to true if so
        // We just set to true as an example her
         strAuth="token "+token;
         $.ajax('http://brdg.me/game', {
         	headers: {
            	Authorization: strAuth
        	},

        success: function (data) {

        //alert("Request worked, open your JS console to see the data.");

            console.log(data);

        //alert(data.games[0].identifier);

        toggle = true;
    }
    });
	}
    if (originalTitle === undefined) {
        originalTitle = document.title;
    }
    if (titleInterval) {
        clearInterval(titleInterval);
    }
    if (toggle) {
        blinked = false;
        titleInterval = setInterval(function() {
            if (blinked) {
                document.title = originalTitle;
            } else {
                document.title = "your turn";
            }
            blinked = !blinked;
        }, 500);
    } else {
        document.title = originalTitle;
    }
}

window.onblur = function() {
    // If we left the page, check if we had active games and blink if so
    setTitle();
};
window.onfocus = function() {
    // When we enter the page just clear the blinking
    setTitle(false);
};

    </script>

</div>	
</body>
</html>