<!DOCTYPE html> 
<html lang="en">
<head>
<style>
body {
font-size:13px;
line-height:17px;
font-family:monospace,Segoe UI Symbol;
white-space:pre-wrap

}
 td {
   border: 1px solid black;
   vertical-align:top;
}
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <meta charset="utf-8" />
    <title>brdg.me web client</title>
</head>
<body>
<table >
<tr>
<td>
	<div id="gamedata"></div>
	<form onsubmit="sendCommand();return false;">
	Command: <input type="text" name="comm" id="comm"><br>
	<input type="Submit">
	</form>
	</td>
	<td>
history:
	<div id="historydata" style="height 100px; overflow-y:scroll;"></div>
	</td>
	<td>
	othergames:
<div id="gamelist" style="height 100px; overflow-y:scroll;"></div>
	</td>
	</tr>
	</table>
    <script>
		var QueryString = function () {
			var query_string = {};
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
				if (typeof query_string[pair[0]] === "undefined") {
					query_string[pair[0]] = pair[1];
				} else if (typeof query_string[pair[0]] === "string") {
					var arr = [ query_string[pair[0]], pair[1] ];
					query_string[pair[0]] = arr;
				} else {
					query_string[pair[0]].push(pair[1]);
				}
			} 
		return query_string;
		} ();
		//alert (QueryString.id);				  
		var strAuth = "token "+QueryString.mail;
		$.ajax('http://brdg.me/game/'+QueryString.id, {
				headers: {
					Authorization: 'token '+QueryString.token
				},
				success: function(data) {
					//alert("Request worked, open your JS console to see the data.");
					console.log(data);
					//alert(data.games[0].identifier);
					//document.getElementById("gamedata").innerHTML=text;
					var text="<pre>" + data.game + "</pre><br /><pre>" + data.commands + "</pre>";
					document.getElementById("gamedata").innerHTML = text;
					var history="<pre>" + data.log + "</pre><br />";
					document.getElementById("historydata").innerHTML = history;					
				}
			});
			getGames(QueryString.token);

	var server = "brdg.me";
	var user = QueryString.mail;
	var exampleSocket = new WebSocket("ws://"+server+"/ws");
	exampleSocket.onopen = function(event) {
    // Authenticate
    console.log('Connected, authenticating');
    console.log(QueryString.token);
    
    exampleSocket.send(JSON.stringify(QueryString.token));
	};
	exampleSocket.onmessage = function(event) {
    // We were sent a game update
    console.log("WebSocket event");
    console.log(JSON.parse(event.data));
    obj = JSON.parse(event.data);
    if(obj.gameId==QueryString.id)
    {
		//location.reload();
		//document.getElementById("gamedata").innerHTML += "YOUR TURN! (please refresh) ";
		console.log("WebSocket event - this game");
    	console.log(JSON.parse(event.data));
    	$.ajax('http://brdg.me/game/'+QueryString.id, {
				headers: {
					Authorization: 'token '+QueryString.token
				},
				success: function(data) {
					console.log("ajax success after websocket event");
					//alert("Request worked, open your JS console to see the data.");
					console.log(data);
					//alert(data.games[0].identifier);
					//document.getElementById("gamedata").innerHTML=text;
					var text="<pre>" + data.game + "</pre><br /><pre>" + data.commands + "</pre>";
					document.getElementById("gamedata").innerHTML = text;
					var history="<pre>" + data.log + "</pre><br />";
					document.getElementById("historydata").innerHTML = history;			
				}
			});
	};
	getGames(QueryString.token);
};
	exampleSocket.onclose = function(event) {
    // Connection crapped out
    alert('The connection died, click OK to refresh');
    //location.reload();
};

function sendCommand(){
	//$("button").click(function(){
	var comm = $("#comm").val();
	var strAuth = "token " + QueryString.token;

//alert(comm);
//alert(strAuth);
	$.ajax('http://brdg.me/game/'+QueryString.id+'/command', {
	headers: {
    Authorization: strAuth
  	},
  	method: 'POST',
	data: {'command': comm},
	success: function(data) { 
			console.log("posted");
			console.log(data);
			var text="<pre>" + data.game + "</pre><br /><pre>" + data.commands + "</pre>";
			document.getElementById("gamedata").innerHTML = text;
			var history="<pre>" + data.log + "</pre><br />";
			document.getElementById("historydata").innerHTML = history;
		    //alert('Successfully posted. Click OK to refresh');
            //location.reload();  
       } 
  	    });
	};
    function getGames(token){
        strAuth="token "+token
         $.ajax('http://brdg.me/game', {

        headers: {
            Authorization: strAuth
        },

        success: function (data) {

        //alert("Request worked, open your JS console to see the data.");

            console.log(data);

        //alert(data.games[0].identifier);

            var text = "";

            for (i = 0; i < data.games.length; i = i + 1) {

                                            
                text += "<a href=\"game.html?id=" + data.games[i].id + "&mail=" + QueryString.mail + "&token=" +  token +"\">" + data.games[i].identifier + "</a> with ";

                for (n = 0; n < data.games[i].playerList.length; n = n + 1){
                    if (n==(data.games[i].playerList.length-1)){
                        text+= data.games[i].playerList[n];
                    }
                    else
                    {
                       text+= data.games[i].playerList[n]+" and "; 
                    }
                    

                }

                text += "<br>"; 

            } 
            document.getElementById("gamelist").innerHTML = text; 
        } 
    });

    }

    </script>

	
</body>
</html>